<link rel="stylesheet" href="/static/styles/sales.css">

<div class="container">
    <div class="row">
        <div class="col-12">
            <h2>Gestión de Ventas</h2>
            <p>Registre las ventas de huevos y genere facturas para sus clientes.</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Nueva Venta</h4>
                </div>
                <div class="card-body">
                    <form id="salesForm">
                        <!-- Información del Cliente -->
                        <div class="mb-4">
                            <h5>Información del Cliente</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customerType" class="form-label">Tipo de Cliente</label>
                                    <select class="form-select" id="customerType" required>
                                        <option value="" selected disabled>Seleccione tipo...</option>
                                        <option value="natural">Persona Natural</option>
                                        <option value="juridical">Persona Jurídica</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="documentType" class="form-label">Tipo de Documento</label>
                                    <select class="form-select" id="documentType" required>
                                        <option value="" selected disabled>Seleccione tipo...</option>
                                        <option value="CC">Cédula de Ciudadanía (CC)</option>
                                        <option value="NIT">NIT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="documentNumber" class="form-label">Número de Documento</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="documentNumber" required>
                                        <button class="btn btn-outline-secondary" type="button" id="searchCustomer">Buscar</button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customerName" class="form-label">Nombre del Cliente</label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>
                            </div>
                        </div>

                        <!-- Productos -->
                        <div class="mb-4">
                            <h5>Productos</h5>
                            <div id="productsContainer">
                                <!-- Fila de producto -->
                                <div class="product-row card mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label">Tipo de Huevo</label>
                                                <select class="form-select egg-type" required>
                                                    <option value="" selected disabled>Seleccione...</option>
                                                    <option value="red">Rojo</option>
                                                    <option value="white">Blanco</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label">Tamaño</label>
                                                <select class="form-select egg-size" required>
                                                    <option value="" selected disabled>Seleccione...</option>
                                                    <option value="A">A</option>
                                                    <option value="AA">AA</option>
                                                    <option value="B">B</option>
                                                    <option value="EXTRA">EXTRA</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 mb-2">
                                                <label class="form-label">Unidad</label>
                                                <select class="form-select unit-type" required>
                                                    <option value="" selected disabled>Seleccione...</option>
                                                    <option value="cubeta">Cubeta (30)</option>
                                                    <option value="dozen" class="natural-only">Docena (12)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 mb-2">
                                                <label class="form-label">Cantidad</label>
                                                <input type="number" class="form-control quantity" min="1" value="1" required>
                                            </div>
                                            <div class="col-md-2 mb-2 d-flex align-items-end">
                                                <button type="button" class="btn btn-danger btn-sm remove-product" style="display: none;">
                                                    <i class="bi bi-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-secondary" id="addProduct">
                                    <i class="bi bi-plus-circle"></i> Agregar Producto
                                </button>
                            </div>
                        </div>

                        <!-- Resumen -->
                        <div class="card mt-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Resumen de la Venta</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 offset-md-4">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td class="text-end">Subtotal:</td>
                                                <td class="text-end" id="subtotal">$0.00</td>
                                            </tr>
                                            <tr>
                                                <td class="text-end">IVA (5%):</td>
                                                <td class="text-end" id="iva">$0.00</td>
                                            </tr>
                                            <tr class="fw-bold">
                                                <td class="text-end">Total:</td>
                                                <td class="text-end" id="total">$0.00</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botón de envío -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-cart-check"></i> Completar Venta
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar búsqueda de cliente
        document.getElementById('searchCustomer').addEventListener('click', function() {
            const docNumber = document.getElementById('documentNumber').value;
            if (!docNumber) {
                alert('Ingrese número de documento');
                return;
            }
            
            fetch(`/api/customers/${docNumber}`)
                .then(response => {
                    if (!response.ok) throw new Error('Cliente no encontrado');
                    return response.json();
                })
                .then(customer => {
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerType').value = customer.customer_type.toLowerCase();
                    document.getElementById('documentType').value = customer.document_type;
                    
                    // Cargar historial de ventas
                    return fetch(`/api/sales/customer/${docNumber}`);
                })
                .then(response => response.json())
                .then(sales => {
                    console.log('Historial de ventas:', sales);
                    // Aquí puedes mostrar el historial si lo deseas
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
        });
        
        // Manejar envío de venta
        document.getElementById('salesForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerDoc = document.getElementById('documentNumber').value;
            if (!customerDoc) {
                alert('Ingrese documento del cliente');
                return;
            }
            
            // Recolectar items
            const items = [];
            document.querySelectorAll('.product-row').forEach(row => {
                items.push({
                    egg_type: row.querySelector('.egg-type').value,
                    egg_size: row.querySelector('.egg-size').value,
                    quantity: parseInt(row.querySelector('.quantity').value),
                    unit_type: row.querySelector('.unit-type').value
                });
            });
            
            if (items.length === 0) {
                alert('Agregue al menos un producto');
                return;
            }
            
            // Enviar venta
            fetch('/api/sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    customer_document: customerDoc,
                    items: items
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Error en venta');
                return response.json();
            })
            .then(data => {
                alert(`Venta registrada! Total: $${data.total}`);
                // Resetear formulario
                document.getElementById('salesForm').reset();
                document.getElementById('subtotal').textContent = '$0.00';
                document.getElementById('iva').textContent = '$0.00';
                document.getElementById('total').textContent = '$0.00';
                
                // Mantener solo un row de producto
                const container = document.getElementById('productsContainer');
                container.innerHTML = `
                    <div class="product-row card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Tipo de Huevo</label>
                                    <select class="form-select egg-type" required>
                                        <option value="" selected disabled>Seleccione...</option>
                                        <option value="red">Rojo</option>
                                        <option value="white">Blanco</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Tamaño</label>
                                    <select class="form-select egg-size" required>
                                        <option value="" selected disabled>Seleccione...</option>
                                        <option value="A">A</option>
                                        <option value="AA">AA</option>
                                        <option value="B">B</option>
                                        <option value="EXTRA">EXTRA</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Unidad</label>
                                    <select class="form-select unit-type" required>
                                        <option value="" selected disabled>Seleccione...</option>
                                        <option value="cubeta">Cubeta (30)</option>
                                        <option value="dozen" class="natural-only">Docena (12)</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Cantidad</label>
                                    <input type="number" class="form-control quantity" min="1" value="1" required>
                                </div>
                                <div class="col-md-2 mb-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger btn-sm remove-product" style="display: none;">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        });
        
        // Manejar agregar producto
        document.getElementById('addProduct').addEventListener('click', function() {
            const container = document.getElementById('productsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'product-row card mb-3';
            newRow.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <select class="form-select egg-type" required>
                                <option value="" selected disabled>Seleccione...</option>
                                <option value="red">Rojo</option>
                                <option value="white">Blanco</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <select class="form-select egg-size" required>
                                <option value="" selected disabled>Seleccione...</option>
                                <option value="A">A</option>
                                <option value="AA">AA</option>
                                <option value="B">B</option>
                                <option value="EXTRA">EXTRA</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <select class="form-select unit-type" required>
                                <option value="" selected disabled>Seleccione...</option>
                                <option value="cubeta">Cubeta (30)</option>
                                <option value="dozen" class="natural-only">Docena (12)</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <input type="number" class="form-control quantity" min="1" value="1" required>
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm remove-product">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Mostrar botón de eliminar en todas las filas excepto la primera
            container.querySelector('.remove-product').style.display = 'block';
            
            container.appendChild(newRow);
            
            // Actualizar cálculos cuando cambian los productos
            const inputs = newRow.querySelectorAll('select, input');
            inputs.forEach(input => {
                input.addEventListener('change', calculateTotals);
            });
        });
        
        // Función para calcular totales
        function calculateTotals() {
            let subtotal = 0;
            
            document.querySelectorAll('.product-row').forEach(row => {
                const eggType = row.querySelector('.egg-type').value;
                const eggSize = row.querySelector('.egg-size').value;
                const unitType = row.querySelector('.unit-type').value;
                const quantity = parseInt(row.querySelector('.quantity').value) || 0;
                
                if (eggType && eggSize && unitType && quantity > 0) {
                    // Obtener precio (esto es un ejemplo, deberías tener esta lógica)
                    let price = 0;
                    if (unitType === 'cubeta') {
                        price = eggType === 'red' ? 400 : 380; // Precios de ejemplo
                    } else {
                        price = eggType === 'red' ? 160 : 150; // Precios de ejemplo
                    }
                    
                    subtotal += price * quantity;
                }
            });
            
            const iva = subtotal * 0.05;
            const total = subtotal + iva;
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }
        
        // Configurar event listeners para cálculos
        document.querySelectorAll('.egg-type, .egg-size, .unit-type, .quantity').forEach(input => {
            input.addEventListener('change', calculateTotals);
        });
    });
</script>