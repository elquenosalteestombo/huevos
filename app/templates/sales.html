<!-- app/templates/sales.html -->



<div class="row">
    <div class="col-12">
        <h2>Gestión de Ventas</h2>
        <p>Registre las ventas de huevos y genere facturas para sus clientes.</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Nueva Venta</h4>
            </div>
            <div class="card-body">
                <form id="salesForm">
                    <!-- Cliente Information -->
                    <div class="mb-4">
                        <h5>Información del Cliente</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerType" class="form-label">Tipo de Cliente</label>
                                <select class="form-select" id="customerType" required>
                                    <option value="" selected disabled>Seleccione tipo...</option>
                                    <option value="natural">Persona Natural</option>
                                    <option value="juridical">Persona Jurídica</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="documentType" class="form-label">Tipo de Documento</label>
                                <select class="form-select" id="documentType" required>
                                    <option value="" selected disabled>Seleccione tipo...</option>
                                    <option value="CC">Cédula de Ciudadanía (CC)</option>
                                    <option value="NIT">NIT</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="documentNumber" class="form-label">Número de Documento</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="documentNumber" required>
                                    <button class="btn btn-outline-secondary" type="button" id="searchCustomer">Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerName" class="form-label">Nombre del Cliente</label>
                                <input type="text" class="form-control" id="customerName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contactPhone" class="form-label">Teléfono (Opcional)</label>
                                <input type="text" class="form-control" id="contactPhone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Correo Electrónico (Opcional)</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div class="mb-4">
                        <h5>Productos</h5>
                        <div id="productsContainer">
                            <!-- Products will be added here -->
                            <div class="product-row card mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Tipo de Huevo</label>
                                            <select class="form-select egg-type" required>
                                                <option value="" selected disabled>Seleccione...</option>
                                                <option value="red">Rojo</option>
                                                <option value="white">Blanco</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Tamaño</label>
                                            <select class="form-select egg-size" required>
                                                <option value="" selected disabled>Seleccione...</option>
                                                <option value="A">A</option>
                                                <option value="AA">AA</option>
                                                <option value="B">B</option>
                                                <option value="EXTRA">EXTRA</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">Unidad</label>
                                            <select class="form-select unit-type" required>
                                                <option value="" selected disabled>Seleccione...</option>
                                                <option value="cubeta">Cubeta (30)</option>
                                                <option value="dozen" class="natural-only">Docena (12)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">Cantidad</label>
                                            <input type="number" class="form-control quantity" min="1" value="1" required>
                                        </div>
                                        <div class="col-md-2 mb-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-danger btn-sm remove-product" style="display: none;">
                                                <i class="bi bi-trash"></i> Eliminar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-4">
                                            <div class="stock-info"></div>
                                        </div>
                                        <div class="col-md-8 text-end">
                                            <div class="price-info"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-secondary" id="addProduct">
                                <i class="bi bi-plus-circle"></i> Agregar Producto
                            </button>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Resumen de la Venta</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8 offset-md-4">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="text-end">Subtotal:</td>
                                            <td class="text-end" id="subtotal">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td class="text-end">IVA (5%):</td>
                                            <td class="text-end" id="iva">$0.00</td>
                                        </tr>
                                        <tr class="fw-bold">
                                            <td class="text-end">Total:</td>
                                            <td class="text-end" id="total">$0.00</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-cart-check"></i> Completar Venta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Egg Price List -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Lista de Precios</h5>
            </div>
            <div class="card-body">
                <h6>Huevos Rojos:</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Tamaño</th>
                            <th>Cubeta (30)</th>
                            <th>Docena (12)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>A</td>
                            <td>$400</td>
                            <td>$160</td>
                        </tr>
                        <tr>
                            <td>AA</td>
                            <td>$450</td>
                            <td>$180</td>
                        </tr>
                        <tr>
                            <td>B</td>
                            <td>$380</td>
                            <td>$152</td>
                        </tr>
                        <tr>
                            <td>EXTRA</td>
                            <td>$500</td>
                            <td>$200</td>
                        </tr>
                    </tbody>
                </table>

                <h6 class="mt-3">Huevos Blancos:</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Tamaño</th>
                            <th>Cubeta (30)</th>
                            <th>Docena (12)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>A</td>
                            <td>$380</td>
                            <td>$152</td>
                        </tr>
                        <tr>
                            <td>AA</td>
                            <td>$420</td>
                            <td>$168</td>
                        </tr>
                        <tr>
                            <td>B</td>
                            <td>$370</td>
                            <td>$148</td>
                        </tr>
                        <tr>
                            <td>EXTRA</td>
                            <td>$480</td>
                            <td>$192</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Summary -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Inventario Disponible</h5>
            </div>
            <div class="card-body" id="inventorySummary">
                <!-- This will be populated by JavaScript -->
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando inventario...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sale Success Modal -->
<div class="modal fade" id="saleSuccessModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">¡Venta Exitosa!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <h4 class="mt-2">Venta Registrada Correctamente</h4>
                </div>
                <p>La factura ha sido generada exitosamente.</p>
                <div class="d-grid gap-2">
                    <a href="#" id="downloadInvoice" class="btn btn-primary" target="_blank">
                        <i class="bi bi-download"></i> Descargar Factura
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" id="newSaleBtn">Nueva Venta</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <h4 class="mt-2">Ha ocurrido un error</h4>
                </div>
                <p id="errorMessage">Ocurrió un error al procesar la venta.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript for the sales page
document.addEventListener('DOMContentLoaded', function() {
    // Load inventory data
    loadInventory();
    
    // Add event listeners
    document.getElementById('customerType').addEventListener('change', updateUnitTypeOptions);
    document.getElementById('searchCustomer').addEventListener('click', searchCustomer);
    document.getElementById('addProduct').addEventListener('click', addProductRow);
    document.getElementById('salesForm').addEventListener('submit', submitSaleForm);
    document.getElementById('newSaleBtn').addEventListener('click', resetForm);
    
    // Add event listeners for the first product row
    setupProductRowListeners(document.querySelector('.product-row'));
    
    // Initial update of unit type options based on customer type
    updateUnitTypeOptions();
});

// Load inventory data from the API
function loadInventory() {
    fetch('/api/inventory')
        .then(response => response.json())
        .then(data => {
            const inventoryDiv = document.getElementById('inventorySummary');
            inventoryDiv.innerHTML = '';
            
            if (data.length === 0) {
                inventoryDiv.innerHTML = '<div class="alert alert-warning">No hay inventario disponible.</div>';
                return;
            }
            
            // Group eggs by type
            const redEggs = data.filter(egg => egg.type === 'red');
            const whiteEggs = data.filter(egg => egg.type === 'white');
            
            // Create tables for each type
            if (redEggs.length > 0) {
                inventoryDiv.appendChild(createEggTable('Huevos Rojos', redEggs, 'egg-red'));
            }
            
            if (whiteEggs.length > 0) {
                inventoryDiv.appendChild(createEggTable('Huevos Blancos', whiteEggs, 'egg-white'));
            }
        })
        .catch(error => {
            console.error('Error loading inventory:', error);
            document.getElementById('inventorySummary').innerHTML = 
                '<div class="alert alert-danger">Error al cargar el inventario.</div>';
        });
}

// Create a table for egg inventory
function createEggTable(title, eggs, className) {
    const div = document.createElement('div');
    div.className = 'mb-3';
    
    const titleElem = document.createElement('h6');
    titleElem.textContent = title;
    div.appendChild(titleElem);
    
    const table = document.createElement('table');
    table.className = 'table table-sm ' + className;
    
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Tamaño</th>
            <th>Stock (unidades)</th>
            <th>Cubetas (30)</th>
        </tr>
    `;
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    eggs.forEach(egg => {
        const tr = document.createElement('tr');
        const cubetas = Math.floor(egg.stock / 30);
        const remainder = egg.stock % 30;
        
        tr.innerHTML = `
            <td>${egg.size}</td>
            <td>${egg.stock}</td>
            <td>${cubetas} ${remainder > 0 ? `+ ${remainder} huevos` : ''}</td>
        `;
        tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    div.appendChild(table);
    
    return div;
}

// Search for an existing customer
function searchCustomer() {
    const documentNumber = document.getElementById('documentNumber').value;
    
    if (!documentNumber) {
        showError('Por favor ingrese un número de documento para buscar.');
        return;
    }
    
    fetch(`/api/customers/${documentNumber}`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    // Customer not found, continue with new customer
                    return null;
                }
                throw new Error('Error al buscar cliente');
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                // Fill customer data
                document.getElementById('customerName').value = data.name;
                document.getElementById('customerType').value = data.customer_type;
                document.getElementById('documentType').value = data.document_type;
                
                if (data.contact_phone) {
                    document.getElementById('contactPhone').value = data.contact_phone;
                }
                
                if (data.email) {
                    document.getElementById('email').value = data.email;
                }
                
                // Update unit type options based on customer type
                updateUnitTypeOptions();
            } else {
                // No customer found, allow creating a new one
                document.getElementById('customerName').focus();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error al buscar el cliente. ' + error.message);
        });
}

// Update unit type options based on customer type
function updateUnitTypeOptions() {
    const customerType = document.getElementById('customerType').value;
    const dozenOptions = document.querySelectorAll('.natural-only');
    
    dozenOptions.forEach(option => {
        if (customerType === 'juridical') {
            option.disabled = true;
            option.style.display = 'none';
            
            // If this option was selected, change to cubeta
            const selectElement = option.closest('select');
            if (selectElement && selectElement.value === 'dozen') {
                selectElement.value = 'cubeta';
            }
        } else {
            option.disabled = false;
            option.style.display = '';
        }
    });
}

// Add a new product row
function addProductRow() {
    const productsContainer = document.getElementById('productsContainer');
    const productRow = document.querySelector('.product-row').cloneNode(true);
    
    // Reset fields
    productRow.querySelectorAll('select, input').forEach(field => {
        if (field.classList.contains('quantity')) {
            field.value = 1;
        } else {
            field.value = '';
        }
    });
    
    // Clear price and stock info
    productRow.querySelector('.price-info').textContent = '';
    productRow.querySelector('.stock-info').textContent = '';
    
    // Show remove button
    productRow.querySelector('.remove-product').style.display = 'block';
    
    // Add event listeners
    setupProductRowListeners(productRow);
    
    // Append to container
    productsContainer.appendChild(productRow);
    
    // Update unit type options
    updateUnitTypeOptions();
}

// Setup event listeners for a product row
function setupProductRowListeners(row) {
    const eggType = row.querySelector('.egg-type');
    const eggSize = row.querySelector('.egg-size');
    const unitType = row.querySelector('.unit-type');
    const quantity = row.querySelector('.quantity');
    const removeBtn = row.querySelector('.remove-product');
    
    // Remove button event
    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            row.remove();
            updateTotals();
        });
    }
    
    // Update price when any field changes
    [eggType, eggSize, unitType, quantity].forEach(field => {
        field.addEventListener('change', function() {
            updateRowPrice(row);
            updateTotals();
        });
    });
}

// Update price information for a row
function updateRowPrice(row) {
    const eggType = row.querySelector('.egg-type').value;
    const eggSize = row.querySelector('.egg-size').value;
    const unitType = row.querySelector('.unit-type').value;
    const quantity = parseInt(row.querySelector('.quantity').value) || 0;
    
    const priceInfo = row.querySelector('.price-info');
    const stockInfo = row.querySelector('.stock-info');
    
    if (!eggType || !eggSize || !unitType) {
        priceInfo.textContent = '';
        stockInfo.textContent = '';
        return;
    }
    
    // Check for egg stock
    fetch(`/api/inventory/${eggType}/${eggSize}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Producto no encontrado');
            }
            return response.json();
        })
        .then(egg => {
            // Display stock information
            const eggsPerUnit = unitType === 'cubeta' ? 30 : 12;
            const totalEggs = quantity * eggsPerUnit;
            const inStock = egg.stock >= totalEggs;
            
            stockInfo.innerHTML = `Stock: <strong>${egg.stock}</strong> huevos`;
            stockInfo.className = 'stock-info ' + (inStock ? 'text-success' : 'text-danger');
            
            if (!inStock) {
                stockInfo.innerHTML += ' <span class="badge bg-danger">Stock insuficiente</span>';
            }
            
            // Calculate price
            let unitPrice = 0;
            
            // Price table
            const priceTable = {
                'red': {
                    'A': {'cubeta': 400, 'dozen': 160},
                    'AA': {'cubeta': 450, 'dozen': 180},
                    'B': {'cubeta': 380, 'dozen': 152},
                    'EXTRA': {'cubeta': 500, 'dozen': 200}
                },
                'white': {
                    'A': {'cubeta': 380, 'dozen': 152},
                    'AA': {'cubeta': 420, 'dozen': 168},
                    'B': {'cubeta': 370, 'dozen': 148},
                    'EXTRA': {'cubeta': 480, 'dozen': 192}
                }
            };
            
            unitPrice = priceTable[eggType][eggSize][unitType];
            const subtotal = unitPrice * quantity;
            
            priceInfo.innerHTML = `Precio unitario: <strong>$${unitPrice.toFixed(2)}</strong> | 
                                  Subtotal: <strong>$${subtotal.toFixed(2)}</strong>`;
        })
        .catch(error => {
            console.error('Error:', error);
            stockInfo.innerHTML = `<span class="text-danger">Error al verificar stock</span>`;
            priceInfo.textContent = '';
        });
}

// Update totals in the summary section
function updateTotals() {
    let subtotal = 0;
    
    document.querySelectorAll('.product-row').forEach(row => {
        const priceInfo = row.querySelector('.price-info').textContent;
        if (priceInfo) {
            const subtotalMatch = priceInfo.match(/Subtotal: \$([0-9.]+)/);
            if (subtotalMatch && subtotalMatch[1]) {
                subtotal += parseFloat(subtotalMatch[1]);
            }
        }
    });
    
    const iva = subtotal * 0.05;
    const total = subtotal + iva;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
}

// Submit the sales form
function submitSaleForm(event) {
    event.preventDefault();
    
    // Validate customer data
    const customerName = document.getElementById('customerName').value;
    const customerType = document.getElementById('customerType').value;
    const documentType = document.getElementById('documentType').value;
    const documentNumber = document.getElementById('documentNumber').value;
    
    if (!customerName || !customerType || !documentType || !documentNumber) {
        showError('Por favor complete todos los datos del cliente.');
        return;
    }
    
    // Validate products
    const productRows = document.querySelectorAll('.product-row');
    const items = [];
    let isValid = true;
    
    productRows.forEach(row => {
        const eggType = row.querySelector('.egg-type').value;
        const eggSize = row.querySelector('.egg-size').value;
        const unitType = row.querySelector('.unit-type').value;
        const quantity = parseInt(row.querySelector('.quantity').value) || 0;
        
        if (!eggType || !eggSize || !unitType || quantity <= 0) {
            isValid = false;
            showError('Por favor complete todos los datos de los productos.');
            return;
        }
        
        items.push({
            egg_type: eggType,
            egg_size: eggSize,
            unit_type: unitType,
            quantity: quantity
        });
    });
    
    if (!isValid || items.length === 0) {
        return;
    }
    
    // First, ensure the customer exists
    const customerData = {
        name: customerName,
        document_type: documentType,
        document_number: documentNumber,
        customer_type: customerType,
        contact_phone: document.getElementById('contactPhone').value,
        email: document.getElementById('email').value
    };
    
    fetch('/api/customers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(customerData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al guardar el cliente');
        }
        return response.json();
    })
    .then(customerResult => {
        // Now create the sale
        return fetch('/api/sales', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                customer_document: documentNumber,
                items: items
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.detail || 'Error al procesar la venta');
            });
        }
        return response.json();
    })
    .then(saleResult => {
        // Set the download invoice link
        document.getElementById('downloadInvoice').href = `/api/invoices/${saleResult.sale_id}`;
        
        // Show success modal
        const saleModal = new bootstrap.Modal(document.getElementById('saleSuccessModal'));
        saleModal.show();
        
        // Reload inventory
        loadInventory();
    })
    .catch(error => {
        console.error('Error:', error);
        showError(error.message);
    });
}

// Show error modal with message
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    errorModal.show();
}

// Reset the form for a new sale
function resetForm() {
    // Close the success modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('saleSuccessModal'));
    if (modal) {
        modal.hide();
    }
    
    // Clear the form
    document.getElementById('salesForm').reset();
    
    // Keep only the first product row and reset it
    const productsContainer = document.getElementById('productsContainer');
    const firstRow = productsContainer.querySelector('.product-row');
    
    // Clear all rows
    productsContainer.innerHTML = '';
    productsContainer.appendChild(firstRow);
    
    // Reset first row values
    firstRow.querySelectorAll('select, input').forEach(field => {
        if (field.classList.contains('quantity')) {
            field.value = 1;
        } else {
            field.value = '';
        }
    });
    
    // Clear price and stock info
    firstRow.querySelector('.price-info').textContent = '';
    firstRow.querySelector('.stock-info').textContent = '';
    
    // Hide remove button
    firstRow.querySelector('.remove-product').style.display = 'none';
    
    // Reset totals
    updateTotals();
}
</script>

<!-- Include Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<!-- Include Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
