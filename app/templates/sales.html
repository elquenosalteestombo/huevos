<link rel="stylesheet" href="../static/styles/sales.css">

<div class="container">
    <div class="row">
        <div class="col-12">
            <h2>Gestión de Ventas</h2>
            <p>Registre las ventas de huevos y genere facturas para sus clientes.</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Nueva Venta</h4>
                </div>
                <div class="card-body">
                    <form id="salesForm">
                        <!-- Información del Cliente -->
                        <div class="mb-4">
                            <h5>Información del Cliente</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customerType" class="form-label">Tipo de Cliente</label>
                                    <select class="form-select" id="customerType" required>
                                        <option value="" selected disabled>Seleccione tipo...</option>
                                        <option value="natural">Persona Natural</option>
                                        <option value="juridical">Persona Jurídica</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="documentType" class="form-label">Tipo de Documento</label>
                                    <select class="form-select" id="documentType" required>
                                        <option value="" selected disabled>Seleccione tipo...</option>
                                        <option value="CC">Cédula de Ciudadanía (CC)</option>
                                        <option value="NIT">NIT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="documentNumber" class="form-label">Número de Documento</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="documentNumber" required>
                                        <button class="btn btn-outline-secondary" type="button" id="searchCustomer">Buscar</button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customerName" class="form-label">Nombre del Cliente</label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>
                            </div>
                        </div>

                        <!-- Productos -->
                        <div class="mb-4">
                            <h5>Productos</h5>
                            <div id="productsContainer">
                                <!-- Fila de producto -->
                                <div class="product-row card mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label">Tipo de Huevo</label>
                                                <select class="form-select egg-type" required>
                                                    <option value="" selected disabled>Seleccione...</option>
                                                    <option value="red">Rojo</option>
                                                    <option value="white">Blanco</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label class="form-label">Tamaño</label>
                                                <select class="form-select egg-size" required>
                                                    <option value="" selected disabled>Seleccione...</option>
                                                    <option value="A">A</option>
                                                    <option value="AA">AA</option>
                                                    <option value="B">B</option>
                                                    <option value="EXTRA">EXTRA</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 mb-2">
                                                <label class="form-label">Unidad</label>
                                                <select class="form-select unit-type" required>
                                                    <option value="" selected disabled>Seleccione...</option>
                                                    <option value="cubeta">Cubeta (30)</option>
                                                    <option value="dozen" class="natural-only">Docena (12)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 mb-2">
                                                <label class="form-label">Cantidad</label>
                                                <input type="number" class="form-control quantity" min="1" value="1" required>
                                            </div>
                                            <div class="col-md-2 mb-2 d-flex align-items-end">
                                                <button type="button" class="btn btn-danger btn-sm remove-product" style="display: none;">
                                                    <i class="bi bi-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-secondary" id="addProduct">
                                    <i class="bi bi-plus-circle"></i> Agregar Producto
                                </button>
                            </div>
                        </div>

                        <!-- Resumen -->
                        <div class="card mt-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Resumen de la Venta</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 offset-md-4">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td class="text-end">Subtotal:</td>
                                                <td class="text-end" id="subtotal">$0.00</td>
                                            </tr>
                                            <tr>
                                                <td class="text-end">IVA (5%):</td>
                                                <td class="text-end" id="iva">$0.00</td>
                                            </tr>
                                            <tr class="fw-bold">
                                                <td class="text-end">Total:</td>
                                                <td class="text-end" id="total">$0.00</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botón de envío -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-cart-check"></i> Completar Venta
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // JavaScript para manejar la lógica de ventas
    document.addEventListener('DOMContentLoaded', function () {
        // Cargar inventario y configurar eventos
        loadInventory();
        document.getElementById('searchCustomer').addEventListener('click', searchCustomer);
        document.getElementById('salesForm').addEventListener('submit', submitSaleForm);
    });

    // Función para buscar cliente
    function searchCustomer() {
        const documentNumber = document.getElementById('documentNumber').value;
        if (!documentNumber) {
            alert('Por favor ingrese un número de documento.');
            return;
        }

        fetch(`/api/customers/${documentNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    document.getElementById('customerName').value = data.name;
                    document.getElementById('customerType').value = data.customer_type;
                } else {
                    alert('Cliente no encontrado. Puede registrarlo.');
                }
            })
            .catch(error => console.error('Error al buscar cliente:', error));
    }

    // Función para enviar el formulario de venta
    function submitSaleForm(event) {
        event.preventDefault();
        // Validar datos y enviar al endpoint `/api/sales`
        // ...
    }
</script>